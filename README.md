# C言語コンパイラ

## 概要

このプロジェクトは、C言語で実装された小規模なコンパイラおよび仮想マシンです。ソースコードを字句解析・構文解析し、スタックベースの中間コードを生成して仮想マシン上で実行します。

### 主な機能

- **字句解析器（Lexical Analyzer）**: トークン化と記号表の管理
- **構文解析器（Parser）**: 再帰下降構文解析による構文木の構築
- **コード生成器（Code Generator）**: スタックベースの中間コード生成
- **仮想マシン（Virtual Machine）**: 生成されたコードの実行環境
- **エラーハンドリング**: 構文エラーの検出と復旧機能

## サポートする文法

このコンパイラは以下の文法をサポートします：

```
プログラム  := 文;{文;}
文          := 代入文
代入文      := 識別子 = 式
式          := 項{(+|-)項}
項          := 因子{(*|/|DIV|MOD)因子}
因子        := 識別子 | 数値 | (式) | -因子
```

### 演算子

- 算術演算子: `+`, `-`, `*`, `/`, `DIV` (整数除算), `MOD` (剰余)
- 単項演算子: `-` (符号反転)

## ファイル構成

| ファイル名 | 説明 |
|-----------|------|
| `main_0.c` | メインプログラム |
| `global_0.h` | グローバル定義・関数プロトタイプ |
| `jiku_2.c` | 字句解析器 |
| `kigouhyou_1.c` | 記号表管理 |
| `syokika_0.c` | 記号表の初期化 |
| `koubun_3.c` | 構文解析器 |
| `code_2.c` | コード生成器 |
| `error_1.c` | エラー処理 |
| `kasoukikai_1.c` | 仮想マシン |
| `test_1.c` | 字句解析テストプログラム |
| `test_2.c` | 記号表テストプログラム |

## ビルド方法

### コンパイラのビルド

```bash
make compiler
```

### 仮想マシンのビルド

```bash
make vm
```

### すべてのテストプログラムをビルド

```bash
make all
```

### クリーンアップ

```bash
make clean
```

## 使用方法

### 基本的な使用フロー

1. **ソースコードをコンパイル**
   ```bash
   ./compiler < source.txt > output.obj
   ```

2. **生成されたコードを実行**
   ```bash
   ./vm < output.obj
   ```

### 入力例

```
x = 10;
y = x + 5;
z = y * 2 - 3;
result = z div 4 mod 3;
```

### 出力例（中間コード）

```
387
0
384
10
388
387
1
386
0
384
5
43
388
387
2
386
1
384
2
42
384
3
45
388
...
261
```

### 実行結果（データメモリ）

```
datamem[0]: 10
datamem[1]: 15
datamem[2]: 27
datamem[3]: 3
```

## テストプログラム

### 字句解析テスト

```bash
make test_lexer
./test_lexer < input.txt
```

入力:
```
x = 10 + y div 2;
```

出力:
```
token = 257, tokenval = 1
token = 61, tokenval = -1
token = 256, tokenval = -1
token = 43, tokenval = -1
token = 257, tokenval = 2
token = 258, tokenval = -1
token = 256, tokenval = -1
token = 59, tokenval = -1
```

### 記号表テスト

```bash
make test_symtable
./test_symtable < input.txt
```

## 技術的特徴

### アーキテクチャ

- **モジュラー設計**: 各機能を独立したファイルに分割
- **スタックベース**: スタックマシンアーキテクチャによる中間コード
- **エラーリカバリ**: 構文エラー発生時のトークンスキップ機能

### 実装の詳細

- **字句解析**: 有限オートマトンによるトークン認識
- **構文解析**: 再帰下降パーサーによるLL(1)文法の解析
- **コード生成**: ポストフィックス記法に基づくスタック操作コード生成
- **記号表**: ハッシュテーブルによる効率的な識別子管理
- **仮想マシン**: スタックベースの命令セットアーキテクチャ

## 中間コード命令セット

| 命令 | コード | 説明 |
|------|--------|------|
| PUSH | 384 | スタックに値をプッシュ |
| POP | 385 | スタックから値をポップ |
| RVALUE | 386 | メモリから値を読み込み |
| LVALUE | 387 | メモリアドレスをプッシュ |
| STORE | 388 | 値をメモリに格納 |
| + | 43 | 加算 |
| - | 45 | 減算 |
| * | 42 | 乗算 |
| / | 47 | 除算 |
| DIV | 258 | 整数除算 |
| MOD | 259 | 剰余 |
| MINUS | 260 | 符号反転 |
| DONE | 261 | プログラム終了 |

## 学習成果

このプロジェクトを通じて以下のスキルを習得しました：

- コンパイラ設計の基礎理論（字句解析、構文解析、コード生成）
- C言語による低レベルプログラミング
- データ構造とアルゴリズム（スタック、記号表、構文木）
- モジュラープログラミングとファイル分割設計
- エラーハンドリングとデバッグ技術

## 制限事項

- サポートする文法は限定的（代入文と式のみ）
- 変数の型は整数のみ
- 制御構造（if、while等）は未実装
- 配列や関数は未サポート

## 今後の拡張可能性

- [ ] 制御構造（if-else、while、for）の追加
- [ ] 関数定義と呼び出し
- [ ] 配列のサポート
- [ ] 型システムの拡張（float、char等）
- [ ] より詳細なエラーメッセージ
- [ ] 最適化パスの実装

## 開発環境

- **言語**: C言語（C99準拠）
- **コンパイラ**: GCC 4.8以上推奨
- **OS**: Linux / macOS / Windows (WSL)
